# å¤šAgentåä½œè°ƒè¯•ç³»ç»Ÿ - ä½¿ç”¨æŒ‡å—

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºå¤šAgentåä½œå’Œè¾©è®ºæœºåˆ¶çš„ä»£ç è°ƒè¯•ç³»ç»Ÿã€‚ç³»ç»Ÿè®©å¤šä¸ªç‹¬ç«‹çš„AI Agentå¹¶è¡Œåˆ†æåŒä¸€ä¸ªbugï¼Œè®°å½•å„è‡ªçš„è°ƒè¯•è¿‡ç¨‹å’Œç»“æœï¼Œç„¶åé€šè¿‡è¾©è®ºæœºåˆ¶è¾¾æˆå…±è¯†ï¼Œæœ€ç»ˆç”Ÿæˆæœ€ä¼˜çš„ä¿®å¤æ–¹æ¡ˆã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä»»åŠ¡åˆ†å‘å±‚                              â”‚
â”‚  - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†                                           â”‚
â”‚  - å¹¶å‘æ§åˆ¶                                               â”‚
â”‚  - è¶…æ—¶å¤„ç†                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Agentç‹¬ç«‹è°ƒè¯•é˜¶æ®µ                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Agent 0 â”‚  â”‚ Agent 1 â”‚  â”‚ Agent 2 â”‚  ...             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚      â”‚             â”‚             â”‚                        â”‚
â”‚      â”œâ”€ CFGåˆ†æ    â”œâ”€ CFGåˆ†æ    â”œâ”€ CFGåˆ†æ               â”‚
â”‚      â”œâ”€ æµ‹è¯•ç”¨ä¾‹   â”œâ”€ æµ‹è¯•ç”¨ä¾‹   â”œâ”€ æµ‹è¯•ç”¨ä¾‹              â”‚
â”‚      â”œâ”€ ä»£ç æ‰§è¡Œ   â”œâ”€ ä»£ç æ‰§è¡Œ   â”œâ”€ ä»£ç æ‰§è¡Œ              â”‚
â”‚      â””â”€ ç”Ÿæˆæ–¹æ¡ˆ   â””â”€ ç”Ÿæˆæ–¹æ¡ˆ   â””â”€ ç”Ÿæˆæ–¹æ¡ˆ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¾©è®ºä¸å…±è¯†é˜¶æ®µ                           â”‚
â”‚  Round 1: æå‡ºæ–¹æ¡ˆ + ç›¸äº’è¯„å®¡                             â”‚
â”‚  Round 2: æ•´åˆåé¦ˆ + è¾¾æˆå…±è¯†                             â”‚
â”‚  Round 3: æœ€ç»ˆä¼˜åŒ– (å¯é€‰)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   éªŒè¯ä¸ç»“æœè®°å½•                           â”‚
â”‚  - è¿è¡Œæµ‹è¯•ç”¨ä¾‹                                           â”‚
â”‚  - è®°å½•å®Œæ•´å†å²                                           â”‚
â”‚  - ç”Ÿæˆåˆ†ææŠ¥å‘Š                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ æ ¸å¿ƒç‰¹æ€§

### 1. å¤šAgentå¹¶è¡Œè°ƒè¯•
- **ç‹¬ç«‹æ€§**: æ¯ä¸ªAgentç‹¬ç«‹åˆ†æbugï¼Œäº’ä¸å¹²æ‰°
- **å¤šæ ·æ€§**: ä¸åŒAgentå¯èƒ½é‡‡ç”¨ä¸åŒçš„åˆ†æç­–ç•¥
- **ç½®ä¿¡åº¦è¯„åˆ†**: æ¯ä¸ªAgentå¯¹è‡ªå·±çš„æ–¹æ¡ˆè¿›è¡Œç½®ä¿¡åº¦è¯„ä¼°

### 2. å®Œæ•´çš„ä¸­é—´ç»“æœè®°å½•
æ¯ä¸ªAgentçš„è°ƒè¯•è¿‡ç¨‹éƒ½ä¼šè®°å½•ï¼š
```python
@dataclass
class AgentDebugResult:
    agent_id: int                          # Agentæ ‡è¯†
    task_id: str                           # ä»»åŠ¡æ ‡è¯†
    success: bool                          # æ˜¯å¦æˆåŠŸ
    corrected_code: str                    # ä¿®å¤åçš„ä»£ç 
    reasoning: str                         # æ¨ç†è¿‡ç¨‹
    confidence_score: float                # ç½®ä¿¡åº¦ (0-1)
    execution_time: float                  # æ‰§è¡Œæ—¶é—´
    test_cases_analyzed: List[str]         # åˆ†æçš„æµ‹è¯•ç”¨ä¾‹
    error_analysis: str                    # é”™è¯¯åˆ†æ
    timestamp: str                         # æ—¶é—´æˆ³
```

### 3. å¤šè½®è¾©è®ºæœºåˆ¶
è¾©è®ºè¿‡ç¨‹è®°å½•ï¼š
```python
@dataclass
class DebateRound:
    round_number: int                      # è½®æ¬¡ç¼–å·
    agent_arguments: List[Dict]            # å„Agentçš„è®ºç‚¹
    consensus_code: Optional[str]          # å…±è¯†ä»£ç 
    disagreement_points: List[str]         # åˆ†æ­§ç‚¹
    timestamp: str                         # æ—¶é—´æˆ³
```

### 4. å®Œæ•´çš„ä»»åŠ¡å†å²
```python
@dataclass
class TaskDebateHistory:
    task_id: str                           # ä»»åŠ¡ID
    buggy_code: str                        # åŸå§‹bugä»£ç 
    agent_results: List[AgentDebugResult]  # æ‰€æœ‰Agentç»“æœ
    debate_rounds: List[DebateRound]       # è¾©è®ºå†å²
    final_code: Optional[str]              # æœ€ç»ˆä»£ç 
    final_test_passed: Optional[bool]      # æµ‹è¯•æ˜¯å¦é€šè¿‡
    total_time: float                      # æ€»è€—æ—¶
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

#### 1. è¿è¡Œå®Œæ•´ç³»ç»Ÿ
```bash
python self_debug_multi_agent_debate.py
```

é…ç½®å‚æ•°ï¼ˆåœ¨mainå‡½æ•°ä¸­ï¼‰ï¼š
```python
dataset_file = "dataset_test/humanevalfix/humanevalpack.jsonl"
max_workers = 4      # å¹¶è¡Œå¤„ç†çš„ä»»åŠ¡æ•°
num_agents = 3       # æ¯ä¸ªä»»åŠ¡çš„Agentæ•°é‡
task_timeout = 600   # æ¯ä¸ªä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
task_limit = 10      # é™åˆ¶å¤„ç†çš„ä»»åŠ¡æ•°ï¼ˆæµ‹è¯•ç”¨ï¼‰
```

#### 2. è¿è¡Œæ¼”ç¤ºç¤ºä¾‹
```bash
python example_multi_agent_debate.py
```

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†ï¼š
- ä¸€ä¸ªç®€å•çš„bugä¿®å¤è¿‡ç¨‹
- 3ä¸ªAgentçš„ç‹¬ç«‹åˆ†æ
- è¾©è®ºè¿‡ç¨‹çš„å¯è§†åŒ–
- æœ€ç»ˆç»“æœçš„éªŒè¯

### è¾“å‡ºç»“æœ

#### æ§åˆ¶å°è¾“å‡º
```
[12:34:56] [0] Processing task_0 with 3 agents
[12:34:57] [Agent 0] Starting debugging with 3 test cases
[12:34:58] [Agent 1] Starting debugging with 3 test cases
[12:34:59] [Agent 2] Starting debugging with 3 test cases
[12:35:10] [0] Phase 1: 3 agents debugging in parallel
[12:35:15] [0] Collected 3 agent results
[12:35:16] [0] Phase 2: Multi-agent debate
[12:35:20] [Debate] Round 1/2
[12:35:25] [Debate] Round 2/2
[12:35:30] [0] Debate completed with 2 rounds
[12:35:31] [0] Phase 3: Testing final code
[12:35:32] [0] âœ… SUCCESS: task_0 after debate
```

#### JSONç»“æœæ–‡ä»¶
ä¿å­˜åœ¨ `dataset_test/humanevalfix/results/debate_results_<timestamp>.json`

ç»“æ„ï¼š
```json
{
  "summary": {
    "total_processed": 10,
    "successful_fixes": 8,
    "test_passed": 7,
    "test_failed": 1,
    "success_rate": 0.8,
    "test_pass_rate": 0.7,
    "tasks_with_debate": 8
  },
  "details": [...],
  "debate_histories": [
    {
      "task_id": "HumanEval/0",
      "buggy_code": "...",
      "agent_results": [
        {
          "agent_id": 0,
          "success": true,
          "corrected_code": "...",
          "reasoning": "...",
          "confidence_score": 0.85,
          "execution_time": 12.5,
          "test_cases_analyzed": [...]
        },
        ...
      ],
      "debate_rounds": [
        {
          "round_number": 1,
          "agent_arguments": [...],
          "consensus_code": "...",
          "disagreement_points": [...]
        }
      ],
      "final_code": "...",
      "final_test_passed": true,
      "total_time": 45.2
    }
  ]
}
```

## ğŸ“Š ç³»ç»Ÿå·¥ä½œæµç¨‹

### é˜¶æ®µ1: Agentç‹¬ç«‹è°ƒè¯• (å¹¶è¡Œ)
```
å¯¹äºæ¯ä¸ªAgent:
  1. æ¥æ”¶ä»»åŠ¡ (buggy_code, test_cases, CFG)
  2. å¯¹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹åˆ†æ:
     - ä½¿ç”¨CFGè¿›è¡Œä»£ç æ‰§è¡Œæ¨¡æ‹Ÿ
     - è¯†åˆ«bugçš„æ ¹æœ¬åŸå› 
     - æå‡ºä¿®å¤æ–¹æ¡ˆ
  3. åˆå¹¶æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„åˆ†æç»“æœ
  4. ç”Ÿæˆæœ€ç»ˆä¿®å¤ä»£ç 
  5. è®¡ç®—ç½®ä¿¡åº¦åˆ†æ•°
  6. è¿”å› AgentDebugResult
```

### é˜¶æ®µ2: å¤šAgentè¾©è®º
```
Round 1:
  - æ”¶é›†æ‰€æœ‰Agentçš„ææ¡ˆ
  - è¯†åˆ«å…±åŒç‚¹å’Œåˆ†æ­§ç‚¹
  - åˆ†ææ¯ä¸ªææ¡ˆçš„ä¼˜ç¼ºç‚¹
  
Round 2:
  - åŸºäºRound 1çš„åˆ†æè¿›è¡Œä¼˜åŒ–
  - è§£å†³ä¸»è¦åˆ†æ­§
  - è¾¾æˆåˆæ­¥å…±è¯†
  
Round 3 (å¯é€‰):
  - ç²¾ç»†åŒ–è°ƒæ•´
  - ç¡®è®¤æœ€ç»ˆæ–¹æ¡ˆ
```

### é˜¶æ®µ3: éªŒè¯ä¸è®°å½•
```
1. è¿è¡Œå®Œæ•´æµ‹è¯•ç”¨ä¾‹
2. è®°å½•æµ‹è¯•ç»“æœ
3. ä¿å­˜å®Œæ•´çš„è°ƒè¯•å†å²:
   - æ‰€æœ‰Agentçš„ä¸­é—´ç»“æœ
   - å®Œæ•´çš„è¾©è®ºè¿‡ç¨‹
   - æœ€ç»ˆçš„ä¿®å¤ä»£ç 
   - æµ‹è¯•éªŒè¯ç»“æœ
```

## ğŸ¯ ä¼˜åŠ¿ä¸ç‰¹ç‚¹

### 1. é²æ£’æ€§æ›´å¼º
- å¤šä¸ªAgentç‹¬ç«‹åˆ†æï¼Œé¿å…å•ç‚¹å¤±è´¥
- å³ä½¿æŸä¸ªAgentå¤±è´¥ï¼Œå…¶ä»–Agentä»å¯ç»§ç»­
- é€šè¿‡è¾©è®ºæœºåˆ¶è¿‡æ»¤æ‰é”™è¯¯æ–¹æ¡ˆ

### 2. å¯è§£é‡Šæ€§å¼º
- å®Œæ•´è®°å½•æ¯ä¸ªAgentçš„æ¨ç†è¿‡ç¨‹
- è¾©è®ºè¿‡ç¨‹å±•ç¤ºä¸åŒè§‚ç‚¹çš„ç¢°æ’
- ä¾¿äºäººå·¥å®¡æŸ¥å’Œç†è§£å†³ç­–è¿‡ç¨‹

### 3. è´¨é‡æ›´é«˜
- å¤šæ ·æ€§ï¼šä¸åŒAgentå¯èƒ½å‘ç°ä¸åŒé—®é¢˜
- äº’è¡¥æ€§ï¼šAgenté—´å¯ä»¥äº’ç›¸çº é”™
- å…±è¯†æœºåˆ¶ï¼šç¡®ä¿æœ€ç»ˆæ–¹æ¡ˆçš„åˆç†æ€§

### 4. å¯è¿½æº¯æ€§
- å®Œæ•´çš„è°ƒè¯•å†å²è®°å½•
- å¯ä»¥è¿½æº¯ä»»ä½•å†³ç­–çš„æ¥æº
- ä¾¿äºåç»­åˆ†æå’Œæ”¹è¿›

## ğŸ”§ é…ç½®å»ºè®®

### Agentæ•°é‡é€‰æ‹©
- **3ä¸ªAgent**: å¹³è¡¡é€Ÿåº¦å’Œè´¨é‡ï¼ˆæ¨èï¼‰
- **5ä¸ªAgent**: è¿½æ±‚æ›´é«˜è´¨é‡ï¼Œå®¹å¿è¾ƒæ…¢é€Ÿåº¦
- **2ä¸ªAgent**: æœ€å°é…ç½®ï¼Œé€‚åˆå¿«é€ŸåŸå‹

### è¾©è®ºè½®æ•°é€‰æ‹©
- **1è½®**: å¿«é€Ÿæ”¶æ•›ï¼Œé€‚åˆç®€å•bug
- **2è½®**: æ ‡å‡†é…ç½®ï¼ˆæ¨èï¼‰
- **3è½®**: å¤æ‚bugéœ€è¦æ·±å…¥è®¨è®º

### å¹¶è¡Œåº¦é…ç½®
```python
max_workers = 4      # åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°
num_agents = 3       # æ¯ä¸ªä»»åŠ¡çš„Agentæ•°

# æ€»å¹¶å‘æ•° = max_workers Ã— num_agents
# æ³¨æ„ï¼šéœ€è¦è€ƒè™‘APIé™åˆ¶å’Œå†…å­˜æ¶ˆè€—
```

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### æ—¶é—´å¤æ‚åº¦
```
å•ä¸ªä»»åŠ¡æ€»æ—¶é—´ = 
  CFGæ„å»ºæ—¶é—´ + 
  max(æ‰€æœ‰Agentçš„è°ƒè¯•æ—¶é—´) +  # å¹¶è¡Œ
  è¾©è®ºæ—¶é—´ Ã— è¾©è®ºè½®æ•° +
  æµ‹è¯•éªŒè¯æ—¶é—´
```

### èµ„æºæ¶ˆè€—
- CPU: Agentå¹¶è¡Œæ‰§è¡Œéœ€è¦å¤šæ ¸æ”¯æŒ
- å†…å­˜: æ¯ä¸ªAgentéœ€è¦ç‹¬ç«‹çš„å†…å­˜ç©ºé—´
- APIè°ƒç”¨: `num_agents Ã— test_cases + debate_rounds` æ¬¡LLMè°ƒç”¨

### ä¼˜åŒ–å»ºè®®
1. ä½¿ç”¨å¼‚æ­¥I/Oå¤„ç†LLM APIè°ƒç”¨
2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´é¿å…æ­»é”
3. å®ç°Agentç»“æœç¼“å­˜æœºåˆ¶
4. æ ¹æ®ä»»åŠ¡å¤æ‚åº¦åŠ¨æ€è°ƒæ•´Agentæ•°é‡

## ğŸ› æ•…éšœå¤„ç†

### Agentå¤±è´¥å¤„ç†
```python
# å¦‚æœæŸä¸ªAgentå¤±è´¥ï¼š
if not agent_results:
    # è¿”å›é”™è¯¯ï¼Œæ•´ä¸ªä»»åŠ¡å¤±è´¥
    
# å¦‚æœéƒ¨åˆ†Agentå¤±è´¥ï¼š
successful_agents = [r for r in agent_results if r.success]
if successful_agents:
    # ç»§ç»­è¾©è®ºï¼Œä½¿ç”¨æˆåŠŸçš„Agentç»“æœ
```

### è¾©è®ºå¤±è´¥å›é€€
```python
# å¦‚æœè¾©è®ºè¿‡ç¨‹å¤±è´¥ï¼š
try:
    final_code, debate_rounds = conduct_debate(...)
except Exception as e:
    # å›é€€åˆ°ç½®ä¿¡åº¦æœ€é«˜çš„Agentç»“æœ
    best_agent = max(successful_agents, 
                     key=lambda x: x.confidence_score)
    final_code = best_agent.corrected_code
```

## ğŸ“ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„Agentç­–ç•¥
```python
def custom_agent_debug(agent_id, buggy_code, ...):
    """è‡ªå®šä¹‰Agentè°ƒè¯•ç­–ç•¥"""
    # å®ç°ä½ çš„è°ƒè¯•é€»è¾‘
    return AgentDebugResult(...)
```

### è‡ªå®šä¹‰è¾©è®ºç­–ç•¥
```python
def custom_debate_strategy(agent_results, ...):
    """è‡ªå®šä¹‰è¾©è®ºç­–ç•¥"""
    # å®ç°ä½ çš„è¾©è®ºé€»è¾‘
    return final_code, debate_rounds
```

### æ·»åŠ æ–°çš„è¯„ä¼°æŒ‡æ ‡
```python
def calculate_solution_quality(code, test_cases):
    """è®¡ç®—æ–¹æ¡ˆè´¨é‡åˆ†æ•°"""
    # å¯ä»¥è€ƒè™‘ï¼š
    # - ä»£ç å¤æ‚åº¦
    # - æµ‹è¯•è¦†ç›–ç‡
    # - æ€§èƒ½æŒ‡æ ‡
    return quality_score
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `self_debug_multi_agent_debate.py`: ä¸»ç³»ç»Ÿå®ç°
- `example_multi_agent_debate.py`: ä½¿ç”¨ç¤ºä¾‹
- `chat.py`: LLMäº¤äº’åŠŸèƒ½
- `utils.py`: å·¥å…·å‡½æ•°
- `complete_cfg_builder.py`: CFGæ„å»ºå™¨

## ğŸ¤ è´¡çŒ®ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æå‡ºï¼

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªç›¸åº”çš„å¼€æºåè®®ã€‚
